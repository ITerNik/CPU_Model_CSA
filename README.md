# Эксперимент. Транслятор и модель
- Терехин Никита Денисович P3208
- ```asm | acc | harv | hw | instr | struct | trap -> stream | mem | cstr | prob2 | spi```
- Базовый вариант
## Язык программирования
### Синтаксис
Описание синтаксиса с использованием расширенной ФБН
- ```?``` - встречается 0 или 1 раз
- ```*``` - встречается 0 или более раз
- ```+``` - встречается 1 или более раз
```
<program> ::= <line> | <line> <program>

<no_arg_op> ::= "HALT"
                | "EI"
                | "DI"
                | "RET"
                | "IRET"
                | "NOP"

<arg_op> ::= "LOAD"
            | "ST"
            | "ADD"
            | "CMP"
            | "JUMP"
            | "JZ"
            | "JNZ"
            | "JEV"
            | "JBE"
            | "CALL"

<line_without_comment> ::= <label> | <space> <instruction>

<line> ::= <line_without_comment> <space> <comment>* "\n"+

<comment> ::= ";" (<label_name> | <space>)*

<space> ::= ("\t" | " " | "\r")*

<word> ::= "WORD " <number>

<vec> ::=  <number> (<label_name> | <number>)

<instruction> ::= <no_arg_op> | <arg_op> " " <adress>

<inner_adress> ::= <label_name> | <number>

<indirect_adress> ::= "[" <inner_adress> "]"

<auto_adress> ::= ("+" | "-") <indirect_adress> | <indirect_adress> ("+" | "-")

<absolute_adress> ::= "#" <inner_adress>

<adress> ::= <indirect_adress> | <inner_adress> | <absolute_adress> | <auto_adress>

<label> ::= <label_name> ":"

<number> ::= [1-9] [0-9]* | "0x" ([0-9] | [A-F])+

<label_name> ::= ([a-z] | [A-Z] | "_") ([a-z] | [A-Z] | "_" | [0-9])*

```

### Семантика
- Язык предполагает последовательное исполнение
- Глобальная область видимости меток

На этапе трансляции метки заменяются численными адресами

### Литералы
- Аргументы команд - численные литералы или метки
- Поддерживаются целочисленные десятичные, а также шестнадцатеричные числа с указанием префикса ```0x```

## Организация памяти
Память организвана согласно Гарвардской модели: инструкций и данные разделены
1. Память команд. Машинное слово - не определено. Реализовано списком классов, описывающих инструкции
2. Память данных. Машинное слово - 32 бита, знаковое. Реализовано целочисленным списком
3. Стек вызовов. Отдельная область памяти для реализации прерываний и подпрограм. Машинное слово - 32 бита, знаковое

## Система команд
### Инструкции
```LOAD ADDR``` - загрузить данные из ячейки памяти в аккуммулятор

```ST ADDR``` - выгрузить данные из аккуммулятоа в ячейку памяти

```ADD ADDR``` - сложить значение ячейки по адресу с текущим в аккумуляторе

```CMP ADDR``` - выставить флаги после сравнения с числом по адресу из памяти

```JUMP ADDR``` - безусловный переход по адресу

```JZ ADDR``` - переход, если установлен флаг нуля

```JNZ ADDR``` - переход, если флаг нуля не установлен

```JEV ADDR``` - переход, если число в аккумуляторе четное

```JBE ADDR``` - переход, если результат сравнения больше либо равен

```CALL ADDR``` - вызвать подпрограмму по адресу в памяти команд

```HALT``` - остановить процессор

```EI / DI``` - разрешить / запретить прерывания от внешних устройств

```RET``` - вернуться из подпрограммы

```IRET``` - вернуться из программы обработчика и сбросить сигнал прерывания

```NOP``` - пустая команда
### Типы адрессации

<table>
  <thead align="center">
    <tr>
      <td>Тип адрессации</td>
      <td>Синтаксис</td>
      <td>Примеры</td>
    </tr>
  </thead>
  <tbody align="center">
    <tr>
      <td>Абсолютная</td>
      <td>ADDR</td>
      <td><pre>ST 0x01<br>LOAD LABEL</pre></td>
    </tr>
    <tr>
      <td>Прямая загрузка</td>
      <td>#ADDR</td>
      <td><pre>ADD #0x4<br>LOAD #LABEL</pre></td>
    </tr>
    <tr>
      <td>Косвенная</td>
      <td>[ADDR]</td>
      <td><pre>CMP [LABEL]<br>LOAD [0x93] </pre></td>
    </tr>
    <tr>
      <td>Пост-инкремент</td>
      <td>[ADDR]+</td>
      <td><pre>ADD [LABEL]+<br>LOAD [0x93]+ </pre></td>
    </tr>
    <tr>
      <td>Пост-декремент</td>
      <td>[ADDR]-</td>
      <td><pre>ST [LABEL]-<br>LOAD [0x93]- </pre></td>
    </tr>
  </tbody>
</table>

### Директивы
```vec n address``` - инициализирует n-ый вектор прерывания
```word number``` - кладет данные в ячейку памяти в соответствии с линейным порядком

### Кодирование инструкций

Машинный код сериализуется в список JSON
Один элемент списка - одна инструкция
```
{
    "index": 13,
    "opcode": "JBE",
    "arg": "22",
    "addressing": 0
}
```
- `index` - адрес в памяти команд

- `opcode` - строка с кодом операции

- `arg` - аргумент

- `addressing` - тип адрессации

## Транслятор
Интерфейс командной строки: translator.py <input_file> <target_file>

Реализовано в модуле: [translator](./src/translator.py)

Этапы трансляции:

- Проверка корректности программы (пересечение меток, закрывающие скобки)
- Трансформирование текста в машинный код
- Подстановка численных значений вместо меток

## Модель процессора

Интерфейс командной строки: `machine.py <machine_code_file> <input_file>`

Реализовано в модуле: [machine](./src/machine.py)
### Регистры
- `ACC` - 32 бита. 
- `DR` - 32 бита
- `CR` - 32 бита
- `AR` - 16 бит
- `PC` - 16 бит
### ControlUnit
![](./assets/ControlUnit.svg)

### DataPath
![](./assets/DataPath.svg)

## Тестирование
